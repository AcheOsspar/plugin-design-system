<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-color: #FFFFFF; --text-color: #1F1F1F; --text-color-secondary: #888888;
      --border-color: #E5E5E5; --button-bg: #0D99FF; --button-text: #FFFFFF;
      --tab-inactive: #888888; --tab-active: #0D99FF;
    }
    body.dark-mode {
      --bg-color: #1F1F1F; --text-color: #FFFFFF; --text-color-secondary: #AAAAAA;
      --border-color: #333333; --tab-inactive: #AAAAAA; --tab-active: #FFFFFF;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
      background-color: var(--bg-color); color: var(--text-color);
      padding: 0; margin: 0; font-size: 12px;
      transition: background-color 0.2s, color 0.2s;
    }
    .container { padding: 16px; }
    .tabs {
      display: flex; border-bottom: 1px solid var(--border-color);
    }
    .tab-button {
      flex: 1; background: none; border: none; padding: 10px;
      cursor: pointer; font-weight: 600; color: var(--tab-inactive);
      border-bottom: 2px solid transparent;
    }
    .tab-button.active {
      color: var(--tab-active); border-bottom-color: var(--tab-active);
    }
    p { color: var(--text-color-secondary); margin: 16px 0; }
    #action-button {
      background-color: var(--button-bg); color: var(--button-text); border: none;
      padding: 10px 16px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: 600;
    }
    .footer {
      margin-top: 16px; border-top: 1px solid var(--border-color);
      padding-top: 12px; color: var(--text-color-secondary); text-align: center;
    }
    #created-count { font-weight: 700; color: var(--text-color); }
    .hidden { display: none; }
    /* Code viewer styles */
    .code-viewer {
      margin-top: 12px; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;
      background: rgba(0,0,0,0.02); position: relative;
    }
    .code-actions { display:flex; gap:8px; margin-bottom:8px; }
    .code-actions button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; font-weight:600 }
    .code-actions .copy { background: var(--button-bg); color: var(--button-text) }
    .code-actions .download { background:#e6e6e6 }
    .code-actions .close { background:transparent; color:var(--tab-inactive); }
    pre.code-block { white-space:pre-wrap; max-height:240px; overflow:auto; background:transparent; margin:0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Segoe UI Mono', monospace; font-size:11px; color:var(--text-color); }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab-button active" data-tab="design">Para Diseño</button>
    <button class="tab-button" data-tab="devs">Para Desarrollo</button>
  </div>

  <div class="container">
    <div id="tab-design-content">
      <p>Selecciona grupos (forma + texto CSS) para crear Estilos de Color en Figma.</p>
    </div>

    <div id="tab-devs-content" class="hidden">
      <p>Selecciona capas de texto (ej: --color-brand #007BFF) para exportar a CSS.</p>
      <!-- Code viewer for exported CSS -->
      <div id="code-viewer" class="code-viewer hidden" aria-hidden="true">
        <div class="code-actions">
          <button class="copy" id="copy-css">Copiar CSS</button>
          <button class="download" id="download-css">Descargar .css</button>
          <button class="close" id="close-viewer" aria-label="Cerrar visor">Cerrar</button>
        </div>
        <pre class="code-block" id="css-block" tabindex="0" role="region" aria-label="Vista previa de CSS">/* CSS export will appear here */</pre>
      </div>
    </div>
    
    <button id="action-button">Crear Estilos</button>

    <div class="footer">
      Total de Estilos Creados: <span id="created-count">0</span>
    </div>
  </div>
    <script>
    const createBtn = document.getElementById('action-button');
    const toggleBtn = document.querySelectorAll('.tab-button'); // Corregido para seleccionar ambos botones
    const countSpan = document.getElementById('created-count');
    const designTabContent = document.getElementById('tab-design-content');
    const devsTabContent = document.getElementById('tab-devs-content');
    let activeTab = 'design';

    // Lógica para cambiar de pestaña
    toggleBtn.forEach(tab => {
      tab.onclick = () => {
        toggleBtn.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeTab = tab.dataset.tab;
        
        if (activeTab === 'design') {
          designTabContent.classList.remove('hidden');
          devsTabContent.classList.add('hidden');
          createBtn.textContent = 'Crear Estilos';
        } else {
          designTabContent.classList.add('hidden');
          devsTabContent.classList.remove('hidden');
          createBtn.textContent = 'Copiar CSS al Portapapeles';
        }
      }
    });

    // Lógica para el botón de acción principal
    createBtn.onclick = () => {
      if (activeTab === 'design') {
        parent.postMessage({ pluginMessage: { type: 'create-styles' } }, '*');
      } else {
        parent.postMessage({ pluginMessage: { type: 'export-css' } }, '*');
      }
    }

    // Escuchamos mensajes del código principal (code.ts)
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg || !msg.type) return;
      if (msg.type === 'update-count') {
        countSpan.textContent = msg.count;
      } else if (msg.type === 'css-to-clipboard') {
        // Mostrar el CSS en el visor y copiar con navigator.clipboard (fallback a textarea)
        const css = msg.css || '';
        const viewer = document.getElementById('code-viewer');
        const cssBlock = document.getElementById('css-block');
        cssBlock.textContent = css;
        viewer.classList.remove('hidden');
        viewer.setAttribute('aria-hidden', 'false');

        // Intentar copiar con navigator.clipboard
        (async () => {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(css);
            } else {
              // Fallback
              const ta = document.createElement('textarea');
              ta.value = css;
              ta.style.position = 'fixed'; ta.style.left = '-9999px'; ta.style.top = '-9999px';
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
            }
            parent.postMessage({ pluginMessage: { type: 'notify', message: '✅ ¡CSS copiado al portapapeles!' } }, '*');
          } catch (err) {
            parent.postMessage({ pluginMessage: { type: 'notify', message: '❌ Error al copiar', error: true } }, '*');
          }
        })();
      }
    }

    // Code viewer actions
    const copyBtn = document.getElementById('copy-css');
    const downloadBtn = document.getElementById('download-css');
    const closeBtn = document.getElementById('close-viewer');
    copyBtn.onclick = async () => {
      const css = document.getElementById('css-block').textContent || '';
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(css);
        } else {
          const ta = document.createElement('textarea'); ta.value = css; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        parent.postMessage({ pluginMessage: { type: 'notify', message: '✅ ¡CSS copiado al portapapeles!' } }, '*');
      } catch (err) {
        parent.postMessage({ pluginMessage: { type: 'notify', message: '❌ Error al copiar', error: true } }, '*');
      }
    }
    downloadBtn.onclick = () => {
      const css = document.getElementById('css-block').textContent || '';
      const blob = new Blob([css], { type: 'text/css;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'export.css'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); document.body.removeChild(a);
    }
    closeBtn.onclick = () => {
      const viewer = document.getElementById('code-viewer');
      viewer.classList.add('hidden');
      viewer.setAttribute('aria-hidden', 'true');
    }
  </script>
</body>
</html>